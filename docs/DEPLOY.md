# Deployment Guide

## Overview

This project uses GitHub Actions for automated deployment. We have two workflows:

- `deploy.yml` - Simple deployment to server when pushing version tags
- `release.yml` - Comprehensive build and release workflow with GitHub releases

## 1. Generate SSH Key Pair

On your local machine, generate a new SSH key specifically for deployment:

```bash
ssh-keygen -t ed25519 -C "github-actions-deployment" -f ~/.ssh/github_actions_deploy
```

## 2. Add Public Key to Server

Copy the public key to your web server:

```bash
ssh-copy-id -i ~/.ssh/github_actions_deploy.pub your-user@your-server-ip
```

Or manually add it to `~/.ssh/authorized_keys` on your server.

## 3. Configure GitHub Secrets

Go to your GitHub repository → Settings → Secrets and variables → Actions

Add the following secrets:

### Required Secrets

#### Server Configuration

##### SERVER_HOST

- Your web server's IP address or domain name
- Example: `123.45.67.89` or `cc.polysignal.com`

##### SERVER_USER

- The SSH username on your web server
- Example: `deploy` or `www-data` (avoid using root)

##### SERVER_SSH_KEY

- Copy the entire contents of your private key:

```bash
cat ~/.ssh/github_actions_deploy
```

- Paste the complete output including `-----BEGIN OPENSSH PRIVATE KEY-----` and `-----END OPENSSH PRIVATE KEY-----`

##### SERVER_DEPLOY_PATH

- The directory path on your server where the website files should be deployed
- Common examples:
  - Nginx: `/usr/share/nginx/html` or `/var/www/cc.polysignal.com`
  - Apache: `/var/www/html` or `/var/www/vhosts/cc.polysignal.com`
  - User directory: `/home/deploy/sites/cc.polysignal.com/public_html`
  - Custom nginx site: `/etc/nginx/sites-available/cc.polysignal.com/html`
- Note: Only the contents of the `web/` folder will be deployed here

#### Email Configuration

```
CONTACT_EMAIL_TO
GMAIL_USERNAME
GMAIL_APP_PASSWORD
RECAPTCHA_SITE_KEY
RECAPTCHA_SECRET_KEY
GTM_CONTAINER_ID
```

## 4. Project Structure

The deployment expects this structure:

```
cc-addon/
├── cc/               # Source files for extension
├── chrome/           # Built Chrome extension (generated)
├── firefox/          # Built Firefox extension (generated)
├── web/              # Website files (deployed to server)
│   ├── index.html
│   ├── privacy.html
│   ├── test.html
│   ├── assets/       # Favicons and images
│   └── addon/        # Interactive demo (generated by build.js)
├── build.js          # Build script
└── .github/
    └── workflows/
        ├── deploy.yml    # Simple deployment
        └── release.yml   # Full release workflow
```

## 5. Deployment Process

### Option 1: Simple Deployment (deploy.yml)

This workflow deploys the website and creates basic GitHub releases.

```bash
# Create and push a version tag
git tag 1.0.0
git push origin 1.0.0
```

### Option 2: Full Release (release.yml)

This workflow creates versioned packages and comprehensive GitHub releases.

```bash
# Create and push a version tag with 'v' prefix
git tag v1.0.0
git push origin v1.0.0
```

## 6. What Gets Deployed

### To Server

- All files from the `web/` folder
- Including the `addon/` folder populated by build.js
- Placeholders in HTML files are replaced with actual values:
  - `YOUR-RECAPTCHA-SITE-KEY` → Your reCAPTCHA site key
  - `GTM-XXXXXXX` → Your GTM container ID
- Server-side configuration files are created:
  - `config.php` - Created from `config.example.php`
  - `.env` - Created with email and reCAPTCHA secrets
- PHP dependencies installed via Composer:
  - PHPMailer for email functionality

### To GitHub Releases

- `currency-converter-chrome-VERSION.zip` - Chrome extension package
- `currency-converter-firefox-VERSION.zip` - Firefox extension package

## 7. Build Process

The workflows automatically run `node build.js` which:

1. Copies extension source files to chrome/ and firefox/ directories
2. Bundles JavaScript modules for each browser
3. Copies the addon to web/addon/ for the interactive demo

## Troubleshooting

### Permission Denied

- Ensure the SSH key has correct permissions (600)
- Verify the public key is in authorized_keys on server
- Check that the deploy user has write access to SERVER_DEPLOY_PATH

### Host Key Verification Failed

- The workflow automatically adds the host to known_hosts
- If issues persist, manually verify the host key

### Build Failures

- Ensure Node.js dependencies are committed (if any)
- Check that build.js has execute permissions
- Verify all source files are present in cc/src/

### Path Issues

- Ensure SERVER_DEPLOY_PATH exists on the server
- The deploy user must have write permissions to this directory
- Remember that only web/ contents are deployed, not the entire repository

### File Permissions

- The workflow sets 644 for files and 755 for directories
- Adjust in the workflow if your server requires different permissions

### Email Issues

- Verify Gmail App Password is correct (not your regular password)
- Ensure 2FA is enabled on your Gmail account
- Check that Composer installed PHPMailer successfully
- Verify PHP has OpenSSL extension enabled for SMTP

### reCAPTCHA Issues

- Ensure you're using v2 "I'm not a robot" (not v3)
- Verify site key matches between Google reCAPTCHA admin and GitHub secret
- Check that your domain is listed in reCAPTCHA settings
- For local testing, add "localhost" to allowed domains

### Missing Dependencies

- The workflow runs `composer install` on the server
- Ensure PHP and Composer are installed on your server
- Check that the server has write permissions for vendor directory

## Testing Locally

Before deploying, test the build process:

```bash
# Run the build script
node build.js

# Check that these directories are created/updated:
# - chrome/
# - firefox/
# - web/addon/

# Test the website locally
cd web
python -m http.server 8000
# Visit http://localhost:8000
```
